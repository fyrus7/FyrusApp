<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    .search-box {
      width: 345px;
      padding: 10px;
      font-size: 16px;
    }
    .result-box {
      margin-top: 10px;
      font-size: 16px;
      white-space: pre-wrap;
      width: 360px;
    }
    .profile-display {
      font-size: 18px;
      margin-top: 10px;
      font-weight: bold;
    }
    .form-container {
      margin-top: 5px;
    }
    .collect-box {
      margin-top: 10px;
      display: none;
    }
    #popupMessage {
      display: none;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #F2BF0C;
      color: black;
      font-size: 30px;
      font-weight: bold;
      border-radius: 5px;
      z-index: 1000;
    }
  </style>
  <title>LSPTK RPC SYSTEM: CREW AREA</title>
</head>
<body>
  <br>
  <br>
  <br>
<center>
  <h1>RPC 1 | Lalaport, KL</h1>
  <form style="text-align: left; display: inline-block;">
    <div class="profile-display" id="profileNameDisplay">Crew: </div>

    <div class="form-container">
      <input type="text" id="searchTerm" class="search-box" placeholder="Masukkan Reg ID atau No. IC...">
      <br><br>

      <select id="searchOption" style="font-size: 16px; padding: 5px; margin-right: 10px;">
        <option value="ABC">ID</option>
        <option value="F">BIB</option>
      </select>

      <input type="button" value="Search / Collect" onclick="search()" style="width: 180px; height: 30px; font-size: 16px; padding: 5px; margin-right: 10px;">
      <input type="button" value="Clear" onclick="clearSearch()" style="width: 100px; height: 30px; font-size: 16px; padding: 5px;">
    </div>
  </form>
  <br><br>

  <div id="result" class="result-box" style="text-align: left;"></div>
  
  <div id="collectBoxes" class="collect-box">
    Wakil <input type="text" id="collectBy1" placeholder="Name" style="width: 100px; height: 10px; font-size: 12px; padding: 5px; margin-left: 5px;">
    <input type="text" id="collectBy2" placeholder="Phone Number" style="width: 100px; height: 10px; font-size: 12px; padding: 5px; margin-left: 5px;">
  </div>

  <div id="popupMessage">SUCCESSFUL<br>COLLECTED</div>
</center>

<audio id="markSound" src="https://github.com/fyrus7/sound/blob/main/achive-sound-132273.mp3?raw=true"></audio>

<script>
  let firstSearchDone = false;

  function search() {
    const searchTerm = document.getElementById('searchTerm').value.trim();
    const searchOption = document.getElementById('searchOption').value;
    const profileName = localStorage.getItem('userProfileName');
    const collectBy1 = document.getElementById('collectBy1').value.trim();
    const collectBy2 = document.getElementById('collectBy2').value.trim();

    if (!searchTerm) {
      document.getElementById('result').innerHTML = '';
      return;
    }

    const corsProxy = 'https://cors-anywhere.herokuapp.com/';
    const googleScriptURL = 'https://script.google.com/macros/s/AKfycby7_y0exo4YQUSQkuA8o_ePRD70L_My_SUcXILtmFbF2hJPdBVm0w_IYVD9OHRFMA_mxA/exec';

    if (!firstSearchDone) {
      fetch(corsProxy + googleScriptURL + '?action=search', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          searchTerm: searchTerm,
          searchOption: searchOption
        })
      })
      .then(response => response.json())
      .then(showResult)
      .catch(error => console.error('Error:', error));

      firstSearchDone = true;
    } else {
      const checkboxes = document.getElementsByClassName('markGreenCheckBox');
      const markedRows = [];
      const markSound = document.getElementById('markSound');

      for (let i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
          markedRows.push({
            row: checkboxes[i].getAttribute('data-row'),
            collectBy1: collectBy1,
            collectBy2: collectBy2
          });
          setTimeout(() => {
            markSound.play();
            showPopupMessage();
          }, 3000);
        }
      }

      fetch(corsProxy + googleScriptURL + '?action=collect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          markedRows: markedRows,
          colorOption: localStorage.getItem('colorOption'),
          profileName: profileName
        })
      })
      .then(() => {
        fetch(corsProxy + googleScriptURL + '?action=search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            searchTerm: searchTerm,
            searchOption: searchOption
          })
        })
        .then(response => response.json())
        .then(showResult);
      })
      .catch(error => console.error('Error:', error));

      firstSearchDone = false;
    }
  }

  function showResult(result) {
    document.getElementById('result').innerHTML = result;
    
    const checkboxes = document.getElementsByClassName('markGreenCheckBox');
    document.getElementById('collectBoxes').style.display = checkboxes.length > 0 ? 'block' : 'none';
  }

  function clearSearch() {
    document.getElementById('searchTerm').value = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('collectBy1').value = '';
    document.getElementById('collectBy2').value = '';
    document.getElementById('collectBoxes').style.display = 'none';

    const corsProxy = 'https://cors-anywhere.herokuapp.com/';
    const googleScriptURL = 'https://script.google.com/macros/s/AKfycby7_y0exo4YQUSQkuA8o_ePRD70L_My_SUcXILtmFbF2hJPdBVm0w_IYVD9OHRFMA_mxA/exec';

    fetch(corsProxy + googleScriptURL + '?action=clear', { method: 'POST' })
      .then(() => firstSearchDone = false)
      .catch(error => console.error('Error:', error));
  }

  function showPopupMessage() {
    const popup = document.getElementById('popupMessage');
    popup.style.display = 'block';
    setTimeout(() => popup.style.display = 'none', 3000);
  }

  function initializePage() {
    const profile = localStorage.getItem('userProfile');
    let profileName = '';
    let colorOption = '';

    switch (profile) {
      case 'noor':
        colorOption = 'lightgreen';
        profileName = 'Noor';
        break;
      case 'amila':
        colorOption = 'yellow';
        profileName = 'Amila';
        break;
      case 'lily':
        colorOption = 'cyan';
        profileName = 'Lily';
        break;
      case 'nurul':
        colorOption = 'lightblue';
        profileName = 'Nurul';
        break;
      case 'zuraini':
        colorOption = 'orange';
        profileName = 'Zuraini';
        break;
      case 'admin':
        colorOption = 'grey';
        profileName = 'Admin';
        break;
    }

    localStorage.setItem('userProfileName', profileName);
    localStorage.setItem('colorOption', colorOption);

    document.getElementById('profileNameDisplay').textContent = 'Crew: ' + profileName;
  }

  window.onload = initializePage;
</script>
</body>
</html>
